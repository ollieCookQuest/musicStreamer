module.exports=[18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},63021,(e,t,r)=>{t.exports=e.x("@prisma/client-2c3a283f134fdcb6",()=>require("@prisma/client-2c3a283f134fdcb6"))},43793,e=>{"use strict";var t=e.i(63021);let r=e.g.prisma||new t.PrismaClient({log:["query"]});e.s(["prisma",0,r])},92123,e=>{"use strict";var t=e.i(43793);let r=process.env.SONOS_CLIENT_ID,o=process.env.SONOS_CLIENT_SECRET,a=process.env.SONOS_CALLBACK_URL,s="https://api.sonos.com/login/v3/oauth/access";function n(){let e=new URLSearchParams({client_id:r,response_type:"code",state:"sonos-auth",scope:"playback-control-all",redirect_uri:a});return`https://api.sonos.com/login/v3/oauth?${e.toString()}`}async function i(e){let n=Buffer.from(`${r}:${o}`).toString("base64"),i=await fetch(s,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Basic ${n}`},body:new URLSearchParams({grant_type:"authorization_code",code:e,redirect_uri:a})});if(!i.ok){let e=await i.text();throw Error(`Failed to exchange code: ${e}`)}let c=await i.json();return await t.prisma.account.create({data:{service:"sonos",accessToken:c.access_token,refreshToken:c.refresh_token,expiresAt:new Date(Date.now()+1e3*c.expires_in)}}),c}async function c(){let e=await t.prisma.account.findFirst({where:{service:"sonos"},orderBy:{createdAt:"desc"}});if(!e)return null;if(e.expiresAt.getTime()>Date.now()+6e4)return e.accessToken;let a=Buffer.from(`${r}:${o}`).toString("base64"),n=await fetch(s,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Basic ${a}`},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:e.refreshToken})});if(!n.ok)throw Error("Failed to refresh token");let i=await n.json();return(await t.prisma.account.update({where:{id:e.id},data:{accessToken:i.access_token,refreshToken:i.refresh_token||e.refreshToken,expiresAt:new Date(Date.now()+1e3*i.expires_in)}})).accessToken}async function d(e,t={}){let r=await c();if(!r)throw Error("No valid token");let o=await fetch(`https://api.ws.sonos.com/control/api/v1${e}`,{...t,headers:{...t.headers,Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});if(!o.ok){let e,t=await o.text();try{e=JSON.parse(t)}catch{e={errorCode:"UNKNOWN",message:t}}let r=Error(`Sonos API error: ${t}`);throw r.errorCode=e.errorCode||"UNKNOWN",r.errorData=e,r}return o.json()}async function l(){return d("/households")}async function u(e){return d(`/households/${e}/groups`)}async function p(e){return d(`/households/${e}/favorites`)}async function h(e){return d(`/groups/${e}/playback`)}async function y(e){return d(`/groups/${e}/playbackMetadata`)}async function f(e,t){return d(`/groups/${e}/favorites`,{method:"POST",body:JSON.stringify({favoriteId:t,action:"replace"})})}async function m(e,t){return d(`/groups/${e}/playback/${t}`,{method:"POST"})}async function g(e){return d(`/groups/${e}/groupVolume`)}async function v(e,t){return d(`/groups/${e}/groupVolume`,{method:"POST",body:JSON.stringify({volume:t})})}async function b(e){return d(`/players/${e}/playerVolume`)}async function w(e,t){return d(`/players/${e}/playerVolume`,{method:"POST",body:JSON.stringify({volume:t})})}async function S(e,t){return d(`/groups/${e}/playback/seek`,{method:"POST",body:JSON.stringify({positionMillis:t})})}async function I(e,t,r){return d(`/groups/${e}/playback/playMode`,{method:"POST",body:JSON.stringify({playModes:{shuffle:t,repeat:r}})})}async function x(e){return d(`/households/${e}/musicServiceAccounts`)}async function O(e,t,r,o){try{return await d(`/households/${e}/musicServiceAccounts/${t}/search`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({term:r,serviceId:o})})}catch(a){console.log("Search endpoint 1 failed, trying alternative...",a?.errorCode);try{return await d(`/households/${e}/musicServices/${o}/search`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({term:r,accountId:t})})}catch(a){console.log("Search endpoint 2 failed, trying alternative...",a?.errorCode);try{return await d(`/households/${e}/musicServiceAccounts/${t}/search`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({term:r,accountId:t,serviceId:o})})}catch(e){throw console.log("Search endpoint 3 failed",e?.errorCode),Error(`Search not available: ${e?.errorCode||e?.message||"Unknown error"}`)}}}}async function R(e,t,r,o){return d(`/households/${e}/musicServiceAccounts/${t}/getMetadata`,{method:"POST",body:JSON.stringify({itemId:{_objectType:"universalMusicObjectId",serviceId:o,objectId:r,accountId:t}})})}async function T(e,t,r,o){let a;a=o?`/households/${e}/musicServiceAccounts/${r}/containers/${o}`:`/households/${e}/musicServiceAccounts/${r}/containers`;try{return await d(a)}catch(a){try{let r=o?`/households/${e}/musicServices/${t}/containers/${o}`:`/households/${e}/musicServices/${t}/containers`;return await d(r)}catch(e){if(console.log("Browse endpoint not available, using fallback"),!o)return{containers:[{name:"Your Library",type:"library",id:{objectId:"spotify:user-library",serviceId:t,accountId:r},_objectType:"container"},{name:"Your Playlists",type:"playlists",id:{objectId:"spotify:user-playlists",serviceId:t,accountId:r},_objectType:"container"},{name:"Recently Played",type:"recent",id:{objectId:"spotify:recently-played",serviceId:t,accountId:r},_objectType:"container"},{name:"Search",type:"search",id:{objectId:"search",serviceId:t,accountId:r},_objectType:"container"}]};return{containers:[],items:[]}}}}async function $(e,t,r,o,a="replace"){return d(`/groups/${e}/playback/playItem`,{method:"POST",body:JSON.stringify({itemId:{_objectType:"universalMusicObjectId",serviceId:r,objectId:t,accountId:o},action:a})})}async function N(e,t,r,o,a){return d(`/households/${e}/favorites`,{method:"POST",body:JSON.stringify({itemId:{_objectType:"universalMusicObjectId",serviceId:r,objectId:t,accountId:o},name:a})})}async function C(e,t){let r=e.includes(":")?e.split(":")[0]:e,o=await l(),a=o.households?.[0]?.id;if(!a)throw Error("No household found");console.log("Grouping with coordinator:",r,"playerIds:",t,"householdId:",a);try{return await d(`/households/${a}/groups/${e}/modifyGroupMembers`,{method:"POST",body:JSON.stringify({playerIds:t})})}catch(o){console.log("modifyGroupMembers endpoint failed, trying setGroupMembers...");try{return await d(`/households/${a}/groups/${e}/setGroupMembers`,{method:"POST",body:JSON.stringify({playerIds:t})})}catch(o){console.log("setGroupMembers with full groupId failed, trying with coordinator ID...");try{return await d(`/households/${a}/groups/${r}/modifyGroupMembers`,{method:"POST",body:JSON.stringify({playerIds:t})})}catch(o){console.log("modifyGroupMembers with coordinatorId failed, trying setGroupMembers...");try{return await d(`/households/${a}/groups/${r}/setGroupMembers`,{method:"POST",body:JSON.stringify({playerIds:t})})}catch(r){console.log("setGroupMembers with coordinatorId failed, trying createGroup...");try{return await d(`/households/${a}/groups/createGroup`,{method:"POST",body:JSON.stringify({playerIds:t})})}catch(r){console.log("createGroup failed, trying direct group endpoints...");try{return await d(`/groups/${e}/modifyGroupMembers`,{method:"POST",body:JSON.stringify({playerIds:t})})}catch(e){throw Error(`All grouping endpoints failed. Last error: ${r.message||e.message}`)}}}}}}}e.s(["addToFavorites",()=>N,"browseMusicService",()=>T,"exchangeCode",()=>i,"fetchFavorites",()=>p,"fetchGroups",()=>u,"fetchHouseholds",()=>l,"getAuthUrl",()=>n,"getMusicServiceAccounts",()=>x,"getMusicServiceMetadata",()=>R,"getPlaybackMetadata",()=>y,"getPlaybackStatus",()=>h,"getPlayerVolume",()=>b,"getVolume",()=>g,"loadFavorite",()=>f,"modifyGroupMembers",()=>C,"playItem",()=>$,"searchMusicService",()=>O,"seek",()=>S,"sendControl",()=>m,"setPlayModes",()=>I,"setPlayerVolume",()=>w,"setVolume",()=>v])},13725,e=>{"use strict";var t=e.i(47909),r=e.i(74017),o=e.i(96250),a=e.i(59756),s=e.i(61916),n=e.i(74677),i=e.i(69741),c=e.i(16795),d=e.i(87718),l=e.i(95169),u=e.i(47587),p=e.i(66012),h=e.i(70101),y=e.i(26937),f=e.i(10372),m=e.i(93695);e.i(52474);var g=e.i(220),v=e.i(89171),b=e.i(92123);async function w(e){try{let t,{term:r,accountId:o}=await e.json();if(!r||0===r.trim().length)return v.NextResponse.json({error:"Missing search term"},{status:400});let a=(await (0,b.fetchHouseholds)()).households;if(!a||0===a.length)return v.NextResponse.json({error:"No households found"},{status:404});let s=a[0].id,n=o;if(n)try{let e=await (0,b.getMusicServiceAccounts)(s),r=e.musicServiceAccounts?.find(e=>e.id===n);t=r?.serviceId}catch(e){console.log("Failed to get serviceId from accounts, trying fallback...");try{let e=await (0,b.fetchFavorites)(s),r=e.items?.find(e=>e.itemId?.accountId===n);r?.itemId?.serviceId&&(t=r.itemId.serviceId)}catch(e){console.error("Failed to get serviceId from favorites:",e)}}else try{let e=(await (0,b.getMusicServiceAccounts)(s)).musicServiceAccounts||[],r=e.find(e=>"9"===e.serviceId);r?(n=r.id,t=r.serviceId):e.length>0&&(n=e[0].id,t=e[0].serviceId)}catch(e){console.log("musicServiceAccounts endpoint not available, trying fallback methods...");try{let e=await (0,b.fetchFavorites)(s),r=function(e){if(!e||0===e.length)return{};for(let t of e){let e=t.itemId;if(e?.accountId&&e?.serviceId)return{accountId:e.accountId,serviceId:e.serviceId}}return{}}(e.items||[]);r.accountId&&r.serviceId&&(n=r.accountId,t=r.serviceId)}catch(e){console.error("Failed to get from favorites:",e)}if(!n)try{let e=(await (0,b.fetchGroups)(s)).groups||[];if(e.length>0){let r=e[0],o=await (0,b.getPlaybackStatus)(r.id),a=function(e){if(!e)return{};let t=e.currentItem;return t?.track?.id?{accountId:t.track.id.accountId,serviceId:t.track.id.serviceId}:t?.id?{accountId:t.id.accountId,serviceId:t.id.serviceId}:{}}(o);a.accountId&&a.serviceId&&(n=a.accountId,t=a.serviceId)}}catch(e){console.error("Failed to get from playback:",e)}}if(!n||!t)return v.NextResponse.json({error:"No music service account available for search",details:"Please ensure a music service (like Spotify) is connected in your Sonos app and try playing some music or adding favorites first"},{status:400});try{let e=await (0,b.searchMusicService)(s,n,r.trim(),t);return v.NextResponse.json({...e,accountId:n,serviceId:t})}catch(e){if(console.error("Search failed:",e),e?.errorCode==="ERROR_RESOURCE_NOT_FOUND"||e?.message?.includes("not available"))return v.NextResponse.json({error:"Search is not available for this music service",details:"The Sonos Control API search endpoint may not be supported for all music services. Try browsing your favorites or currently playing content instead.",errorCode:e?.errorCode},{status:404});throw e}}catch(e){return console.error("Search API error:",e),v.NextResponse.json({error:"Failed to search",details:e.message||e.details||"Search is not available. Please ensure a music service is connected and try browsing favorites instead.",errorCode:e?.errorCode},{status:500})}}e.s(["POST",()=>w],40944);var S=e.i(40944);let I=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/sonos/library/search/route",pathname:"/api/sonos/library/search",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/sonos/library/search/route.ts",nextConfigOutput:"",userland:S}),{workAsyncStorage:x,workUnitAsyncStorage:O,serverHooks:R}=I;function T(){return(0,o.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:O})}async function $(e,t,o){I.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/sonos/library/search/route";v=v.replace(/\/index$/,"")||"/";let b=await I.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!b)return t.statusCode=400,t.end("Bad Request"),null==o.waitUntil||o.waitUntil.call(o,Promise.resolve()),null;let{buildId:w,params:S,nextConfig:x,parsedUrl:O,isDraftMode:R,prerenderManifest:T,routerServerContext:$,isOnDemandRevalidate:N,revalidateOnlyGenerated:C,resolvedPathname:k,clientReferenceManifest:P,serverActionsManifest:E}=b,A=(0,i.normalizeAppPath)(v),_=!!(T.dynamicRoutes[A]||T.routes[k]),j=async()=>((null==$?void 0:$.render404)?await $.render404(e,t,O,!1):t.end("This page could not be found"),null);if(_&&!R){let e=!!T.routes[k],t=T.dynamicRoutes[A];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await j();throw new m.NoFallbackError}}let M=null;!_||I.isDev||R||(M="/index"===(M=k)?"/":M);let U=!0===I.isDev||!_,q=_&&!U;E&&P&&(0,n.setManifestsSingleton)({page:v,clientReferenceManifest:P,serverActionsManifest:E});let D=e.method||"GET",F=(0,s.getTracer)(),G=F.getActiveScopeSpan(),H={params:S,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:o.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,o,a)=>I.onRequestError(e,t,o,a,$)},sharedContext:{buildId:w}},J=new c.NodeNextRequest(e),L=new c.NodeNextResponse(t),B=d.NextRequestAdapter.fromNodeNextRequest(J,(0,d.signalFromNodeResponse)(t));try{let n=async e=>I.handle(B,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=r.get("next.route");if(o){let t=`${D} ${o}`;e.setAttributes({"next.route":o,"http.route":o,"next.span_name":t}),e.updateName(t)}else e.updateName(`${D} ${v}`)}),i=!!(0,a.getRequestMeta)(e,"minimalMode"),c=async a=>{var s,c;let d=async({previousCacheEntry:r})=>{try{if(!i&&N&&C&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await n(a);e.fetchMetrics=H.renderOpts.fetchMetrics;let c=H.renderOpts.pendingWaitUntil;c&&o.waitUntil&&(o.waitUntil(c),c=void 0);let d=H.renderOpts.collectedTags;if(!_)return await (0,p.sendResponse)(J,L,s,H.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,o=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:o}}}}catch(t){throw(null==r?void 0:r.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:N})},!1,$),t}},l=await I.handleResponse({req:e,nextConfig:x,cacheKey:M,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:C,responseGenerator:d,waitUntil:o.waitUntil,isMinimalMode:i});if(!_)return null;if((null==l||null==(s=l.value)?void 0:s.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(c=l.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",N?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),R&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,h.fromNodeOutgoingHttpHeaders)(l.value.headers);return i&&_||m.delete(f.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,y.getCacheControlHeader)(l.cacheControl)),await (0,p.sendResponse)(J,L,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};G?await c(G):await F.withPropagatedContext(e.headers,()=>F.trace(l.BaseServerSpan.handleRequest,{spanName:`${D} ${v}`,kind:s.SpanKind.SERVER,attributes:{"http.method":D,"http.target":e.url}},c))}catch(t){if(t instanceof m.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:A,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:N})},!1,$),_)throw t;return await (0,p.sendResponse)(J,L,new Response(null,{status:500})),null}}e.s(["handler",()=>$,"patchFetch",()=>T,"routeModule",()=>I,"serverHooks",()=>R,"workAsyncStorage",()=>x,"workUnitAsyncStorage",()=>O],13725)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__50ac5f84._.js.map