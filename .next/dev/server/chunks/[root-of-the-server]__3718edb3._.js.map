{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/ollie/Documents/dev/musicStreamer/src/lib/db.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = global as unknown as { prisma: PrismaClient };\n\nexport const prisma =\n  globalForPrisma.prisma ||\n  new PrismaClient({\n    log: [\"query\"],\n  });\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AAEC,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,sMAAY,CAAC;IACf,KAAK;QAAC;KAAQ;AAChB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 63, "column": 0}, "map": {"version":3,"sources":["file:///Users/ollie/Documents/dev/musicStreamer/src/lib/sonos.ts"],"sourcesContent":["import { prisma } from \"./db\";\n\nconst CLIENT_ID = process.env.SONOS_CLIENT_ID;\nconst CLIENT_SECRET = process.env.SONOS_CLIENT_SECRET;\nconst CALLBACK_URL = process.env.SONOS_CALLBACK_URL;\n\nconst BASE_URL = \"https://api.ws.sonos.com/control/api/v1\";\nconst AUTH_URL = \"https://api.sonos.com/login/v3/oauth\";\nconst TOKEN_URL = \"https://api.sonos.com/login/v3/oauth/access\";\n\nexport function getAuthUrl() {\n  const params = new URLSearchParams({\n    client_id: CLIENT_ID!,\n    response_type: \"code\",\n    state: \"sonos-auth\",\n    scope: \"playback-control-all\",\n    redirect_uri: CALLBACK_URL!,\n  });\n  return `${AUTH_URL}?${params.toString()}`;\n}\n\nexport async function exchangeCode(code: string) {\n  const auth = Buffer.from(`${CLIENT_ID}:${CLIENT_SECRET}`).toString(\"base64\");\n  \n  const response = await fetch(TOKEN_URL, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/x-www-form-urlencoded\",\n      Authorization: `Basic ${auth}`,\n    },\n    body: new URLSearchParams({\n      grant_type: \"authorization_code\",\n      code,\n      redirect_uri: CALLBACK_URL!,\n    }),\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    throw new Error(`Failed to exchange code: ${error}`);\n  }\n\n  const data = await response.json();\n  \n  await prisma.account.create({\n    data: {\n      service: \"sonos\",\n      accessToken: data.access_token,\n      refreshToken: data.refresh_token,\n      expiresAt: new Date(Date.now() + data.expires_in * 1000),\n    },\n  });\n\n  return data;\n}\n\nexport async function getValidToken() {\n  const account = await prisma.account.findFirst({\n    where: { service: \"sonos\" },\n    orderBy: { createdAt: \"desc\" },\n  });\n\n  if (!account) return null;\n\n  if (account.expiresAt.getTime() > Date.now() + 60000) {\n    return account.accessToken;\n  }\n\n  const auth = Buffer.from(`${CLIENT_ID}:${CLIENT_SECRET}`).toString(\"base64\");\n  const response = await fetch(TOKEN_URL, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/x-www-form-urlencoded\",\n      Authorization: `Basic ${auth}`,\n    },\n    body: new URLSearchParams({\n      grant_type: \"refresh_token\",\n      refresh_token: account.refreshToken,\n    }),\n  });\n\n  if (!response.ok) {\n    throw new Error(\"Failed to refresh token\");\n  }\n\n  const data = await response.json();\n\n  const updated = await prisma.account.update({\n    where: { id: account.id },\n    data: {\n      accessToken: data.access_token,\n      refreshToken: data.refresh_token || account.refreshToken,\n      expiresAt: new Date(Date.now() + data.expires_in * 1000),\n    },\n  });\n\n  return updated.accessToken;\n}\n\nasync function sonosRequest(endpoint: string, options: RequestInit = {}) {\n  const token = await getValidToken();\n  if (!token) throw new Error(\"No valid token\");\n\n  const response = await fetch(`${BASE_URL}${endpoint}`, {\n    ...options,\n    headers: {\n      ...options.headers,\n      Authorization: `Bearer ${token}`,\n      \"Content-Type\": \"application/json\",\n    },\n  });\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    let errorData;\n    try {\n      errorData = JSON.parse(errorText);\n    } catch {\n      errorData = { errorCode: \"UNKNOWN\", message: errorText };\n    }\n    \n    // Create error with errorCode property for easier handling\n    const error = new Error(`Sonos API error: ${errorText}`);\n    (error as any).errorCode = errorData.errorCode || \"UNKNOWN\";\n    (error as any).errorData = errorData;\n    throw error;\n  }\n\n  return response.json();\n}\n\nexport async function fetchHouseholds() {\n  return sonosRequest(\"/households\");\n}\n\nexport async function fetchGroups(householdId: string) {\n  return sonosRequest(`/households/${householdId}/groups`);\n}\n\nexport async function fetchPlayers(householdId: string) {\n  return sonosRequest(`/households/${householdId}/players`);\n}\n\nexport async function fetchFavorites(householdId: string) {\n  return sonosRequest(`/households/${householdId}/favorites`);\n}\n\nexport async function getPlaybackStatus(groupId: string) {\n  return sonosRequest(`/groups/${groupId}/playback`);\n}\n\nexport async function getPlaybackMetadata(groupId: string) {\n  return sonosRequest(`/groups/${groupId}/playbackMetadata`);\n}\n\nexport async function loadFavorite(groupId: string, favoriteId: string) {\n  return sonosRequest(`/groups/${groupId}/favorites`, {\n    method: \"POST\",\n    body: JSON.stringify({ favoriteId, action: \"replace\" }),\n  });\n}\n\nexport async function sendControl(groupId: string, command: \"play\" | \"pause\" | \"skipToNextTrack\" | \"skipToPreviousTrack\") {\n  return sonosRequest(`/groups/${groupId}/playback/${command}`, {\n    method: \"POST\",\n  });\n}\n\nexport async function getVolume(groupId: string) {\n  return sonosRequest(`/groups/${groupId}/groupVolume`);\n}\n\nexport async function setVolume(groupId: string, volume: number) {\n  return sonosRequest(`/groups/${groupId}/groupVolume`, {\n    method: \"POST\",\n    body: JSON.stringify({ volume }),\n  });\n}\n\nexport async function getPlayerVolume(playerId: string) {\n  return sonosRequest(`/players/${playerId}/playerVolume`);\n}\n\nexport async function setPlayerVolume(playerId: string, volume: number) {\n  return sonosRequest(`/players/${playerId}/playerVolume`, {\n    method: \"POST\",\n    body: JSON.stringify({ volume }),\n  });\n}\n\nexport async function seek(groupId: string, positionMillis: number) {\n  return sonosRequest(`/groups/${groupId}/playback/seek`, {\n    method: \"POST\",\n    body: JSON.stringify({ positionMillis }),\n  });\n}\n\nexport async function getMusicServiceAccounts(householdId: string) {\n  return sonosRequest(`/households/${householdId}/musicServiceAccounts`);\n}\n\nexport async function searchMusicService(householdId: string, accountId: string, term: string, serviceId: string) {\n  // Try different search endpoint structures\n  try {\n    return await sonosRequest(`/households/${householdId}/musicServiceAccounts/${accountId}/search`, {\n      method: \"POST\",\n      body: JSON.stringify({\n        term,\n        serviceId,\n      }),\n    });\n  } catch (error: any) {\n    // Try alternative structure\n    try {\n      return await sonosRequest(`/households/${householdId}/musicServices/${serviceId}/search`, {\n        method: \"POST\",\n        body: JSON.stringify({\n          term,\n          accountId,\n        }),\n      });\n    } catch (error2: any) {\n      throw new Error(\"Search not available in Control API\");\n    }\n  }\n}\n\nexport async function getMusicServiceMetadata(householdId: string, accountId: string, itemId: string, serviceId: string) {\n  return sonosRequest(`/households/${householdId}/musicServiceAccounts/${accountId}/getMetadata`, {\n    method: \"POST\",\n    body: JSON.stringify({\n      itemId: {\n        _objectType: \"universalMusicObjectId\",\n        serviceId,\n        objectId: itemId,\n        accountId,\n      },\n    }),\n  });\n}\n\n// Try to browse using search with empty term or common categories\nexport async function browseMusicService(householdId: string, musicServiceId: string, accountId: string, containerId?: string) {\n  // Try different endpoint structures\n  let endpoint;\n  \n  if (containerId) {\n    // Try with container ID\n    endpoint = `/households/${householdId}/musicServiceAccounts/${accountId}/containers/${containerId}`;\n  } else {\n    // Try root containers - different possible structures\n    // Structure 1: Using musicServiceAccounts\n    endpoint = `/households/${householdId}/musicServiceAccounts/${accountId}/containers`;\n  }\n  \n  try {\n    return await sonosRequest(endpoint);\n  } catch (error: any) {\n    // If that fails, try alternative structure with serviceId\n    try {\n      const altEndpoint = containerId\n        ? `/households/${householdId}/musicServices/${musicServiceId}/containers/${containerId}`\n        : `/households/${householdId}/musicServices/${musicServiceId}/containers`;\n      return await sonosRequest(altEndpoint);\n    } catch (error2: any) {\n      // If both fail, return common Spotify categories as fallback\n      console.log(\"Browse endpoint not available, using fallback\");\n      if (!containerId) {\n        return {\n          containers: [\n            { \n              name: \"Your Library\", \n              type: \"library\", \n              id: { objectId: \"spotify:user-library\", serviceId: musicServiceId, accountId },\n              _objectType: \"container\"\n            },\n            { \n              name: \"Your Playlists\", \n              type: \"playlists\", \n              id: { objectId: \"spotify:user-playlists\", serviceId: musicServiceId, accountId },\n              _objectType: \"container\"\n            },\n            { \n              name: \"Recently Played\", \n              type: \"recent\", \n              id: { objectId: \"spotify:recently-played\", serviceId: musicServiceId, accountId },\n              _objectType: \"container\"\n            },\n            { \n              name: \"Search\", \n              type: \"search\", \n              id: { objectId: \"search\", serviceId: musicServiceId, accountId },\n              _objectType: \"container\"\n            },\n          ],\n        };\n      }\n      return { containers: [], items: [] };\n    }\n  }\n}\n\nexport async function playItem(groupId: string, itemId: string, serviceId: string, accountId: string, action: \"replace\" | \"addNext\" | \"addToEnd\" = \"replace\") {\n  return sonosRequest(`/groups/${groupId}/playback/playItem`, {\n    method: \"POST\",\n    body: JSON.stringify({\n      itemId: {\n        _objectType: \"universalMusicObjectId\",\n        serviceId,\n        objectId: itemId,\n        accountId,\n      },\n      action,\n    }),\n  });\n}\n\nexport async function addToFavorites(householdId: string, itemId: string, serviceId: string, accountId: string, name: string) {\n  return sonosRequest(`/households/${householdId}/favorites`, {\n    method: \"POST\",\n    body: JSON.stringify({\n      itemId: {\n        _objectType: \"universalMusicObjectId\",\n        serviceId,\n        objectId: itemId,\n        accountId,\n      },\n      name,\n    }),\n  });\n}\n\nexport async function modifyGroupMembers(groupId: string, playerIds: string[]) {\n  // Sonos Control API: Modify group membership to include all specified players\n  // This creates a synchronized group where all players play the same content\n  // Reference: https://docs.sonos.com/reference/groups\n  \n  // Extract coordinator ID from group ID (format: RINCON_xxx:timestamp)\n  // The coordinator is the first player in the group\n  const coordinatorId = groupId.includes(':') ? groupId.split(':')[0] : groupId;\n  \n  // Get household ID first\n  const householdsData = await fetchHouseholds();\n  const householdId = householdsData.households?.[0]?.id;\n  \n  if (!householdId) {\n    throw new Error(\"No household found\");\n  }\n  \n  console.log(\"Grouping with coordinator:\", coordinatorId, \"playerIds:\", playerIds, \"householdId:\", householdId);\n  \n  // According to Sonos API docs: https://docs.sonos.com/reference/groups\n  // Try the correct endpoint formats:\n  \n  // Format 1: POST /households/{householdId}/groups/{groupId}/modifyGroupMembers\n  try {\n    return await sonosRequest(`/households/${householdId}/groups/${groupId}/modifyGroupMembers`, {\n      method: \"POST\",\n      body: JSON.stringify({\n        playerIds: playerIds,\n      }),\n    });\n  } catch (error: any) {\n    console.log(\"modifyGroupMembers endpoint failed, trying setGroupMembers...\");\n    \n    // Format 2: POST /households/{householdId}/groups/{groupId}/setGroupMembers\n    try {\n      return await sonosRequest(`/households/${householdId}/groups/${groupId}/setGroupMembers`, {\n        method: \"POST\",\n        body: JSON.stringify({\n          playerIds: playerIds,\n        }),\n      });\n    } catch (error2: any) {\n      console.log(\"setGroupMembers with full groupId failed, trying with coordinator ID...\");\n      \n      // Format 3: POST /households/{householdId}/groups/{coordinatorId}/modifyGroupMembers\n      try {\n        return await sonosRequest(`/households/${householdId}/groups/${coordinatorId}/modifyGroupMembers`, {\n          method: \"POST\",\n          body: JSON.stringify({\n            playerIds: playerIds,\n          }),\n        });\n      } catch (error3: any) {\n        console.log(\"modifyGroupMembers with coordinatorId failed, trying setGroupMembers...\");\n        \n        // Format 4: POST /households/{householdId}/groups/{coordinatorId}/setGroupMembers\n        try {\n          return await sonosRequest(`/households/${householdId}/groups/${coordinatorId}/setGroupMembers`, {\n            method: \"POST\",\n            body: JSON.stringify({\n              playerIds: playerIds,\n            }),\n          });\n        } catch (error4: any) {\n          console.log(\"setGroupMembers with coordinatorId failed, trying createGroup...\");\n          \n          // Format 5: POST /households/{householdId}/groups/createGroup (create new group)\n          try {\n            return await sonosRequest(`/households/${householdId}/groups/createGroup`, {\n              method: \"POST\",\n              body: JSON.stringify({\n                playerIds: playerIds,\n              }),\n            });\n          } catch (error5: any) {\n            console.log(\"createGroup failed, trying direct group endpoints...\");\n            \n            // Format 6: POST /groups/{groupId}/modifyGroupMembers (fallback)\n            try {\n              return await sonosRequest(`/groups/${groupId}/modifyGroupMembers`, {\n                method: \"POST\",\n                body: JSON.stringify({\n                  playerIds: playerIds,\n                }),\n              });\n            } catch (error6: any) {\n              // Format 7: POST /groups/{coordinatorId}/modifyGroupMembers (final fallback)\n              throw new Error(`All grouping endpoints failed. Last error: ${error5.message || error6.message}`);\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\nexport async function setGroupVolume(groupId: string, volume: number) {\n  return setVolume(groupId, volume);\n}\n\nexport async function sendControlToGroups(groupIds: string[], command: \"play\" | \"pause\" | \"skipToNextTrack\" | \"skipToPreviousTrack\") {\n  // Send control to multiple groups simultaneously\n  return Promise.all(groupIds.map(groupId => sendControl(groupId, command)));\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 533, "column": 0}, "map": {"version":3,"sources":["file:///Users/ollie/Documents/dev/musicStreamer/src/app/api/sonos/players/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { fetchHouseholds, fetchGroups } from \"@/lib/sonos\";\n\nexport async function GET() {\n  try {\n    const householdsData = await fetchHouseholds();\n    const households = householdsData.households;\n\n    if (!households || households.length === 0) {\n      return NextResponse.json({ players: [] });\n    }\n\n    const householdId = households[0].id;\n    // Players endpoint doesn't exist, extract players from groups instead\n    const groupsData = await fetchGroups(householdId);\n    const groups = groupsData.groups || [];\n    \n    // Extract unique players from all groups\n    const players: any[] = [];\n    const seenPlayerIds = new Set<string>();\n    \n    groups.forEach((group: any) => {\n      // Extract coordinator/player ID from group ID (format: RINCON_xxx:timestamp)\n      if (group.id && group.id.includes(':')) {\n        const playerId = group.id.split(':')[0];\n        if (!seenPlayerIds.has(playerId)) {\n          seenPlayerIds.add(playerId);\n          // Use group name only if it's not a grouped name (doesn't contain + or &)\n          const isUngrouped = !group.name?.includes('+') && !group.name?.includes('&');\n          players.push({\n            id: playerId,\n            name: isUngrouped ? group.name : `Player ${playerId.slice(-4)}`,\n            coordinatorId: playerId,\n          });\n        }\n      }\n      \n      // Also check for players array in group - these have individual names\n      if (group.players && Array.isArray(group.players)) {\n        group.players.forEach((player: any) => {\n          const playerId = player.id || player.playerId || player.player?.id;\n          if (playerId && !seenPlayerIds.has(playerId)) {\n            seenPlayerIds.add(playerId);\n            // Prefer player.name, fallback to finding matching ungrouped group name\n            let playerName = player.name || player.playerName || player.displayName;\n            \n            // If no name, try to find an ungrouped group with this coordinator\n            if (!playerName || playerName.startsWith('Player ')) {\n              const matchingGroup = groups.find((g: any) => {\n                const gCoordinatorId = g.coordinatorId || (g.id?.includes(':') ? g.id.split(':')[0] : g.id);\n                return gCoordinatorId === playerId && !g.name?.includes('+') && !g.name?.includes('&');\n              });\n              if (matchingGroup) {\n                playerName = matchingGroup.name;\n              }\n            }\n            \n            players.push({\n              id: playerId,\n              name: playerName || `Player ${playerId.slice(-4)}`,\n              coordinatorId: playerId,\n            });\n          }\n        });\n      }\n      \n      // Also check playerIds array - these represent players in a grouped zone\n      if (group.playerIds && Array.isArray(group.playerIds)) {\n        group.playerIds.forEach((playerId: string) => {\n          if (playerId && !seenPlayerIds.has(playerId)) {\n            seenPlayerIds.add(playerId);\n            // Try to find an ungrouped group with this coordinator for the name\n            const matchingGroup = groups.find((g: any) => {\n              const gCoordinatorId = g.coordinatorId || (g.id?.includes(':') ? g.id.split(':')[0] : g.id);\n              return gCoordinatorId === playerId && !g.name?.includes('+') && !g.name?.includes('&');\n            });\n            \n            players.push({\n              id: playerId,\n              name: matchingGroup?.name || `Player ${playerId.slice(-4)}`,\n              coordinatorId: playerId,\n            });\n          }\n        });\n      }\n    });\n\n    return NextResponse.json({\n      players: players,\n    });\n  } catch (error) {\n    console.error(\"Players API error:\", error);\n    return NextResponse.json({ error: \"Failed to fetch players\" }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}