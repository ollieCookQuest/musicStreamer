{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/ollie/Documents/dev/musicStreamer/src/lib/db.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = global as unknown as { prisma: PrismaClient };\n\nexport const prisma =\n  globalForPrisma.prisma ||\n  new PrismaClient({\n    log: [\"query\"],\n  });\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AAEC,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,sMAAY,CAAC;IACf,KAAK;QAAC;KAAQ;AAChB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 63, "column": 0}, "map": {"version":3,"sources":["file:///Users/ollie/Documents/dev/musicStreamer/src/app/api/spotify/library/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/db\";\n\nasync function getSpotifyToken() {\n  const account = await prisma.account.findFirst({\n    where: { service: \"spotify\" },\n  });\n\n  if (!account) {\n    throw new Error(\"Spotify not connected\");\n  }\n\n  // Check if token needs refresh\n  if (account.expiresAt.getTime() <= Date.now() + 60000) {\n    const SPOTIFY_CLIENT_ID = process.env.SPOTIFY_CLIENT_ID;\n    const SPOTIFY_CLIENT_SECRET = process.env.SPOTIFY_CLIENT_SECRET;\n\n    const response = await fetch(\"https://accounts.spotify.com/api/token\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\n        Authorization: `Basic ${Buffer.from(`${SPOTIFY_CLIENT_ID}:${SPOTIFY_CLIENT_SECRET}`).toString(\"base64\")}`,\n      },\n      body: new URLSearchParams({\n        grant_type: \"refresh_token\",\n        refresh_token: account.refreshToken,\n      }),\n    });\n\n    if (!response.ok) {\n      throw new Error(\"Failed to refresh Spotify token\");\n    }\n\n    const data = await response.json();\n\n    await prisma.account.update({\n      where: { id: account.id },\n      data: {\n        accessToken: data.access_token,\n        expiresAt: new Date(Date.now() + (data.expires_in || 3600) * 1000),\n        refreshToken: data.refresh_token || account.refreshToken,\n      },\n    });\n\n    return data.access_token;\n  }\n\n  return account.accessToken;\n}\n\nasync function spotifyRequest(endpoint: string) {\n  const token = await getSpotifyToken();\n  \n  const response = await fetch(`https://api.spotify.com/v1${endpoint}`, {\n    headers: {\n      Authorization: `Bearer ${token}`,\n      \"Content-Type\": \"application/json\",\n    },\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    throw new Error(`Spotify API error: ${error}`);\n  }\n\n  return response.json();\n}\n\nexport async function GET(request: NextRequest) {\n  const { searchParams } = new URL(request.url);\n  const type = searchParams.get(\"type\"); // \"playlists\", \"recent\", \"library\", \"search\"\n  const query = searchParams.get(\"q\");\n\n  try {\n    if (type === \"playlists\") {\n      const data = await spotifyRequest(\"/me/playlists?limit=50\");\n      return NextResponse.json({\n        items: data.items.map((playlist: any) => ({\n          id: { objectId: playlist.uri, serviceId: \"9\", accountId: \"sn_2\" },\n          name: playlist.name,\n          imageUrl: playlist.images?.[0]?.url,\n          images: playlist.images,\n          type: \"playlist\",\n          _objectType: \"container\",\n          description: `${playlist.tracks.total} tracks`,\n        })),\n      });\n    }\n\n    if (type === \"recent\") {\n      const data = await spotifyRequest(\"/me/player/recently-played?limit=50\");\n      return NextResponse.json({\n        items: data.items.map((item: any) => ({\n          id: { objectId: item.track.uri, serviceId: \"9\", accountId: \"sn_2\" },\n          name: item.track.name,\n          imageUrl: item.track.album?.images?.[0]?.url,\n          images: item.track.album?.images,\n          type: \"track\",\n          _objectType: \"track\",\n          artist: { name: item.track.artists.map((a: any) => a.name).join(\", \") },\n          playedAt: item.played_at,\n        })),\n      });\n    }\n\n    if (type === \"library\") {\n      const data = await spotifyRequest(\"/me/tracks?limit=50\");\n      return NextResponse.json({\n        items: data.items.map((item: any) => ({\n          id: { objectId: item.track.uri, serviceId: \"9\", accountId: \"sn_2\" },\n          name: item.track.name,\n          imageUrl: item.track.album?.images?.[0]?.url,\n          images: item.track.album?.images,\n          type: \"track\",\n          _objectType: \"track\",\n          artist: { name: item.track.artists.map((a: any) => a.name).join(\", \") },\n        })),\n      });\n    }\n\n    if (type === \"search\" && query) {\n      const data = await spotifyRequest(`/search?q=${encodeURIComponent(query)}&type=track,album,playlist,artist&limit=50`);\n      const items = [\n        ...(data.tracks?.items || []).map((track: any) => ({\n          id: { objectId: track.uri, serviceId: \"9\", accountId: \"sn_2\" },\n          name: track.name,\n          imageUrl: track.album?.images?.[0]?.url,\n          type: \"track\",\n          _objectType: \"track\",\n          artist: { name: track.artists.map((a: any) => a.name).join(\", \") },\n        })),\n        ...(data.albums?.items || []).map((album: any) => ({\n          id: { objectId: album.uri, serviceId: \"9\", accountId: \"sn_2\" },\n          name: album.name,\n          imageUrl: album.images?.[0]?.url,\n          type: \"album\",\n          _objectType: \"container\",\n          artist: { name: album.artists.map((a: any) => a.name).join(\", \") },\n        })),\n        ...(data.playlists?.items || []).map((playlist: any) => ({\n          id: { objectId: playlist.uri, serviceId: \"9\", accountId: \"sn_2\" },\n          name: playlist.name,\n          imageUrl: playlist.images?.[0]?.url,\n          type: \"playlist\",\n          _objectType: \"container\",\n        })),\n      ];\n      return NextResponse.json({ items });\n    }\n\n    return NextResponse.json({ error: \"Invalid type\" }, { status: 400 });\n  } catch (error: any) {\n    console.error(\"Spotify API error:\", error);\n    if (error.message.includes(\"not connected\")) {\n      return NextResponse.json({ error: \"Spotify not connected\", needsAuth: true }, { status: 401 });\n    }\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}